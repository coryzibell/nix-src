{ config, pkgs, lib, zed-editor, mise, ... }:

let
  # Combined development libraries for mise and general development
  devLibs = pkgs.symlinkJoin {
    name = "dev-libs";
    paths = with pkgs; [
      # === Core System Libraries ===
      dbus.dev
      dbus.lib
      dbus.out
      glibc.bin
      glibc.dev
      glibc.out
      glibc.static
      libbacktrace
      libiconv
      libuuid.bin
      libuuid.dev
      libuuid.out

      # === Compression Libraries ===
      brotli.dev
      brotli.lib
      brotli.out
      bzip2.dev
      bzip2.out
      libdeflate
      libzip.dev
      libzip.out
      xz.dev
      xz.out
      zlib.dev
      zlib.out
      zstd.bin
      zstd.dev
      zstd.out

      # === Cryptography & Security ===
      libargon2
      libsodium.dev
      libsodium.out
      openssl.bin
      openssl.dev
      openssl.out

      # === SELinux Security ===
      libselinux.bin
      libselinux.dev
      libselinux.out
      libsepol.bin
      libsepol.dev
      libsepol.out

      # === Text Processing & Internationalization ===
      enchant2.dev
      enchant2.out
      expat.dev
      expat.out
      gettext
      icu.dev
      icu.out
      oniguruma.dev
      oniguruma.lib
      oniguruma.out
      pcre2.dev
      pcre2.out
      re2c

      # === Data Structures & Parsing ===
      gmp.dev
      gmp.out
      mpdecimal.dev
      mpdecimal.out
      libyaml.dev
      libyaml.out

      # === Databases ===
      gdbm.dev
      gdbm.lib
      gdbm.out
      mariadb
      postgresql.dev
      postgresql.lib
      postgresql.out
      sqlite.dev
      sqlite.out
      unixODBC

      # === LDAP ===
      openldap.dev
      openldap.out

      # === Networking & Transfer ===
      curl.bin
      curl.dev
      curl.out

      # === Terminal & CLI ===
      libedit.dev
      libedit.out
      ncurses.dev
      ncurses.out
      ncurses5
      readline.dev
      readline.out

      # === Build Tools & FFI ===
      bison
      libffi.dev
      libffi.out

      # === Graphics & OpenGL ===
      glfw
      libGL.dev
      libGL.out
      libGLU
      libGLU.dev
      libGLU.out
      libepoxy.dev
      libepoxy.out
      libglvnd.dev
      libglvnd.out
      mesa.out

      # === Image Processing & Formats ===
      imagemagick.dev
      imagemagick.out
      lerc.dev
      lerc.out
      libavif.dev
      libavif.out
      libjpeg.bin
      libjpeg.dev
      libjpeg.out
      libpng.dev
      libpng.out
      libtiff.bin
      libtiff.dev
      libtiff.out
      libwebp

      # === Font & Text Rendering ===
      fontconfig.dev
      fontconfig.lib
      fontconfig.out
      freetype.dev
      freetype.out
      fribidi.dev
      fribidi.out
      graphite2.dev
      graphite2.out
      harfbuzz.dev
      harfbuzz.out
      pango.dev
      pango.out

      # === GTK & GUI Libraries ===
      atk.dev
      atk.out
      cairo.dev
      cairo.out
      gdk-pixbuf.dev
      gdk-pixbuf.out
      glib.dev
      glib.out
      gtk3.dev
      gtk3.out
      libsysprof-capture
      sysprof.dev
      sysprof.lib
      sysprof.out

      # === Graphics Utilities ===
      gd.bin
      gd.dev
      gd.out
      pixman

      # === Thai Language Support ===
      libdatrie.bin
      libdatrie.dev
      libdatrie.lib
      libdatrie.out
      libthai.dev
      libthai.out

      # === X11 & Wayland Display ===
      libx11.dev
      libx11.out
      libxkbcommon.dev
      libxkbcommon.out
      libxrandr.dev
      libxrandr.out
      libxcomposite.dev
      libxcomposite.out
      libxcursor.dev
      libxcursor.out
      libxdamage.dev
      libxdamage.out
      libxtst
      wayland.dev
      wayland.out
      wayland-protocols
      xorg.libXau.dev
      xorg.libXau.out
      xorg.libXdmcp.dev
      xorg.libXdmcp.out
      xorg.libXext.dev
      xorg.libXext.out
      xorg.libXft.dev
      xorg.libXft.out
      xorg.libXfixes.dev
      xorg.libXfixes.out
      xorg.libXi.dev
      xorg.libXi.out
      xorg.libXinerama.dev
      xorg.libXinerama.out
      xorg.libXrender.dev
      xorg.libXrender.out
      xorg.libxcb.dev
      xorg.libxcb.out
      xorg.xorgproto

      # === Tcl/Tk GUI Framework ===
      tcl
      tk
      tk.dev
      tk.out

      # === XML & XSLT Processing ===
      html-tidy
      libxml2.bin
      libxml2.dev
      libxml2.out
      libxslt.bin
      libxslt.dev
      libxslt.out

      # === PHP Extensions ===
      php84Extensions.igbinary.dev
      php84Extensions.igbinary.out
    ];
  };
in

{
  home = {
    username = "kautau";
    homeDirectory = "/home/kautau";
    sessionPath = [
      "/home/kautau/.ghcup/bin"
    ];

    shellAliases = {
        vi = "hx";
        vim = "hx";
        nano = "hx";
        ls = "eza -lamuUh --git --git-repos --octal-permissions --color-scale --color-scale-mode gradient --classify=always";
        update = ''
          sudo nix-channel --update && \
          sudo nix flake update --flake /etc/nixos && \
          sudo nixos-rebuild switch --flake /etc/nixos -v -v && \
          sudo nix-store --optimise && \
          mise upgrade && \
          mise prune && \
          ghcup install ghc latest && \
          ghcup install cabal latest && \
          ghcup install stack latest && \
          ghcup install hls latest && \
          ghcup set ghc latest && \
          ghcup set cabal latest && \
          ghcup set stack latest && \
          ghcup set hls latest
        '';
        prune = ''
          ghcup gc --unset && \
          nix-env --delete-generations old && \
          sudo nix-store --gc && \
          nix-collect-garbage -d && \
          sudo nix-collect-garbage -d
        '';
        commit_update = "cd ~/src/nix-src && git add * && git commit -m \"$(openssl dgst -sha256 -binary < /etc/nixos/flake.lock | base100)\"";
      };

      sessionVariables = {
        EDITOR = "hx";
        MISE_NODE_COREPACK = "true";

        # Build flags
        CFLAGS = "-O2 -g -I${devLibs}/include";
        CXXFLAGS = "-O2 -g -I${devLibs}/include";
        PYTHON_CFLAGS = "-I${devLibs}/include";
        CPPFLAGS = "-I${devLibs}/include";
        LDFLAGS = "-L${devLibs}/lib";
        LD_LIBRARY_PATH = "${devLibs}/lib:${pkgs.stdenv.cc.cc.lib}/lib";
        PKG_CONFIG_PATH = "${devLibs}/lib/pkgconfig:${devLibs}/share/pkgconfig";

        # Nix build environment
        NIX_CFLAGS_COMPILE = "-I${devLibs}/include";
        NIX_LDFLAGS = "-L${devLibs}/lib";

        # CMake configuration
        CMAKE_PREFIX_PATH = "${devLibs}";
        CMAKE_INCLUDE_PATH = "${devLibs}/include";
        CMAKE_LIBRARY_PATH = "${devLibs}/lib";

        # Python/mise configuration
        PYTHON_CONFIGURE_OPTS = "--with-openssl=${devLibs}";

        # Erlang/Elixir configuration
        KERL_CONFIGURE_OPTIONS = "--enable-wx --enable-webview --with-ssl=${devLibs} --with-odbc=${devLibs}";

        # PHP configuration
        PHP_CONFIGURE_OPTIONS = "--with-openssl=${devLibs} --with-curl=${devLibs} --with-gettext=${devLibs} --with-sodium=${devLibs}";

        # Ruby configuration (skip test extensions to avoid NixOS glibc compatibility issues)
        RUBY_CONFIGURE_OPTS = "--disable-install-doc --with-out-ext=-test-/cxxanyargs";

        # Clang/LLVM library paths
        ZLIB_ROOT = "${devLibs}";
        ZLIB_LIBRARY = "${devLibs}/lib/libz.so";
        ZLIB_INCLUDE_DIR = "${devLibs}/include";
        OPENSSL_ROOT = "${devLibs}";
        OPENSSL_LIBRARIES = "${devLibs}/lib";
        OPENSSL_INCLUDE_DIR = "${devLibs}/include";
        LIBXML2_ROOT = "${devLibs}";
        LIBXML2_LIBRARIES = "${devLibs}/lib";
        LIBXML2_INCLUDE_DIR = "${devLibs}/include";
        Backtrace_ROOT = "${pkgs.libbacktrace}";
        Backtrace_LIBRARIES = "${pkgs.libbacktrace}/lib";
        Backtrace_INCLUDE_DIR = "${pkgs.libbacktrace}/include";
        LIBEDIT_ROOT = "${devLibs}";
        LIBEDIT_LIBRARIES = "${devLibs}/lib";
        LIBEDIT_INCLUDE_DIR = "${devLibs}/include";

        # Rust linker configuration
        RUSTFLAGS = "-L ${devLibs}/lib -L ${pkgs.stdenv.cc.cc.lib}/lib -C link-arg=-Wl,-rpath,${devLibs}/lib -C link-arg=-Wl,-rpath,${pkgs.stdenv.cc.cc.lib}/lib";
      };

    packages =
      let
        # Automatically load all .nix scripts from ./scripts
        scriptDir = ./scripts;
        scriptFiles = builtins.attrNames (builtins.readDir scriptDir);
        nixScripts = builtins.filter (name: pkgs.lib.hasSuffix ".nix" name) scriptFiles;
        scripts = map (name: pkgs.callPackage (scriptDir + "/${name}") { }) nixScripts;
      in scripts ++ (with pkgs; [

      # Add devLibs to packages so it's in the environment
      devLibs

      # Zed editor from flake
      # zed-editor.packages.${pkgs.stdenv.hostPlatform.system}.default

      fastfetch
      nnn # terminal file manager

      # archives
      zip
      xz
      unzip
      p7zip

      # utils
      ripgrep # recursively searches directories for a regex pattern
      jq # A lightweight and flexible command-line JSON processor
      yq-go # yaml processor https://github.com/mikefarah/yq
      eza # A modern replacement for ‘ls’
      fzf # A command-line fuzzy finder

      # networking tools
      mtr # A network diagnostic tool
      iperf3
      dnsutils  # `dig` + `nslookup`
      ldns # replacement of `dig`, it provide the command `drill`
      aria2 # A lightweight multi-protocol & multi-source command-line download utility
      socat # replacement of openbsd-netcat
      nmap # A utility for network discovery and security auditing
      ipcalc  # it is a calculator for the IPv4/v6 addresses

      # misc
      cowsay
      file
      which
      tree
      gnused
      gnutar
      gawk
      gnupg
      findutils

      # nix related
      #
      # it provides the command `nom` works just like `nix`
      # with more details log output
      nix-output-monitor

      # productivity
      hugo # static site generator
      glow # markdown previewer in terminal

      btop  # replacement of htop/nmon
      iotop # io monitoring
      iftop # network monitoring

      # system call monitoring
      strace # system call monitoring
      ltrace # library call monitoring
      lsof # list open files

      # system tools
      sysstat
      lm_sensors # for `sensors` command
      ethtool
      pciutils # lspci
      usbutils # lsusb

      # build-essential tools
      (lib.hiPrio clang)
      gcc
      cmake
      ninja
      gnumake
      automake
      autoconf
      autogen
      libtool
      pkg-config
      binutils
      gdb
      patch
      m4
      flex

      # libraries
      rlwrap
      bc
      mesa
      (wxGTK32.override { withWebKit = true; })
      wxc
      #llvmPackages.clangWithLibcAndBasicRtAndLibcxx
      go
      darcs
      gh # GitHub CLI
      helix
      micro
      emacs
      mercurialFull
      bubblewrap

      nixd
      nil
    ]);
    stateVersion = "25.05";
  };

  programs = {

    bash = {
      enable = true;
      # ... other things here
      initExtra = ''
        # Ensure development environment is available in all bash sessions
        if [ -f "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/hm-session-vars.sh"
        fi
        '';
    };

    zsh = {
      enable = true;
      # ... other things here
      # initExtra = ''
      #   eval "$(mise activate zsh)"
      #   '';
      oh-my-zsh = {
        enable = true;
      };
    };

    git = {
      enable = true;
      settings = {
        user.name = "Cory Zibell";
        user.email = "cory@zibell.cloud";
        init.defaultBranch = "main";
        core.sshCommand = "/mnt/c/WINDOWS/System32/OpenSSH/ssh.exe";
      };
    };

    mise = {
      enable = true;
      package = mise.packages.${pkgs.stdenv.hostPlatform.system}.default;
      enableBashIntegration = true;
      enableZshIntegration = true;
      enableNushellIntegration = true;

      globalConfig = {
        settings = {
          all_compile = false;
          exec_auto_install = false;
          jobs = 1;
          # verbose = true;
        };

        tools = {
          node = "latest";
          "cargo:bottom" = "latest";
          "cargo:eza" = "latest";
          "cargo:tealdeer" = "latest";
          "cargo:base100" = "latest";
          "cargo:speedo" = "latest";
          "cargo:ascim" = "latest";
          "cargo:cargo-outdated" = "latest";
          "npm:npm" = "latest";
          "npm:cordova" = "latest";
          "npm:corepack" = "latest";
          "npm:@quasar/cli" = "latest";
          "npm:@google/gemini-cli" = "latest";
          "npm:@github/copilot" = "latest";
          cargo-binstall = "latest";
          bun = "latest";
          deno = "latest";
          elixir = "latest";
          erlang = "latest";
          ghcup = "latest";
          go = "latest";
          java = "oracle-graalvm";
          flutter = "latest";
          php = "latest";
          python = "latest";
          ruby = "latest";
          rust = "latest";
          zig = "latest";
        };
      };

    };

    nushell = {
      enable = true;
      # The config.nu can be anywhere you want if you like to edit your Nushell with Nu
      # configFile.source = ./.../config.nu;
      # for editing directly to config.nu

      extraEnv = ''

      '';

      extraConfig = ''
        $env.config.hooks.env_change = {}
        let carapace_completer = {|spans|
          carapace $spans.0 nushell $spans | from json
        }
        $env.config = {
          show_banner: false,
          hooks: {
            command_not_found: {|cmd|
              let output = (run-external command-not-found $cmd)
              if $output != "" {
                echo $output
              } else {
                echo "Command '$cmd' not found."
              }
            }
          },
          completions: {
            case_sensitive: false # case-sensitive completions
            quick: true    # set to false to prevent auto-selecting completions
            partial: true    # set to false to prevent partial filling of the prompt
            algorithm: "fuzzy"    # prefix or fuzzy
            external: {
              # set to false to prevent nushell looking into $env.PATH to find more suggestions
                enable: true
              # set to lower can improve completion performance at the cost of omitting some options
                max_results: 100
                completer: $carapace_completer # check 'carapace_completer'
            }
          }
        }
        $env.PATH = ($env.PATH |
          split row (char esep) |
          prepend /home/kautau/.apps |
          append /usr/bin/env
        )
        '';
    };

    carapace = {
      enable = true;
      enableBashIntegration = true;
      enableZshIntegration = true;
      enableNushellIntegration = true;
    };

    starship = {
      enable = true;
      settings = {
        add_newline = false;
        character = {
          success_symbol = "[➜](bold green)";
          error_symbol = "[➜](bold red)";
        };
      };
    };


    home-manager = {
      enable = true;
    };
  };
}
